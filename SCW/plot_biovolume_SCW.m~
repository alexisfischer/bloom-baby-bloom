%% Plot biovolume for dinoflagellates vs diatoms
% parts modified from "compile_biovolume_summaries"
%  Alexis D. Fischer, University of California - Santa Cruz, June 2018

year=2017; %USER

%%%% Step 1: Load in data
% Chemical and Physical
resultpath = 'C:\Users\kudelalab\Documents\GitHub\bloom-baby-bloom\SCW\';
load([resultpath 'Data\ROMS\MB_temp_sal_' num2str(year) ''],'ROMS');
load([resultpath 'Data\SCW_master'],'SC');
load([resultpath 'Data\Winds_MB'],'W');

% Biovolume
figpath = 'C:\Users\kudelalab\Documents\GitHub\bloom-baby-bloom\SCW\';
resultpath = 'F:\IFCB104\class\summary\'; %Where you want the summary file to go
load([resultpath 'summary_biovol_allTB' num2str(year) ''],'class2useTB',...
    'classcountTB','classbiovolTB','ml_analyzedTB','mdateTB','filelistTB');
    % convert to cubic microns
    micron_factor = 1/3.4; %microns per pixel
    classbiovolTB = classbiovolTB*micron_factor^3;

%%%% Step 2: Determine what fraction of Cell-derived biovolume is 
% Dinoflagellates vs Diatoms vs Classes of interest

%select total living biovolume 
[ ind_cell, class_label ] = get_cell_ind_CA( class2useTB, class2useTB );
[xmat, ymat ] = timeseries2ydmat(mdateTB, nansum(classbiovolTB(:,ind_cell),2));
[xmat ymat_ml ] = timeseries2ydmat(mdateTB, ml_analyzedTB);

%select only diatoms
[ ind_diatom, class_label ] = get_diatom_ind_CA( class2useTB, class2useTB );
[xdiat, ydiat ] = timeseries2ydmat(mdateTB, nansum(classbiovolTB(:,ind_diatom),2));
[xdiat ydiat_ml ] = timeseries2ydmat(mdateTB, ml_analyzedTB);

%select only dinoflagellates
[ ind_dino, class_label ] = get_dino_ind_CA( class2useTB, class2useTB );
[xdino, ydino ] = timeseries2ydmat(mdateTB, nansum(classbiovolTB(:,ind_dino),2));
[xdino ydino_ml ] = timeseries2ydmat(mdateTB, ml_analyzedTB);

%extract biovolume for each class
for i=1:length(class2useTB)
    BIO(i).class = class2useTB(i);
    [~,BIO(i).bio ] = timeseries2ydmat(mdateTB, classbiovolTB(:,i));
    [~,BIO(i).mL ] = timeseries2ydmat(mdateTB, ml_analyzedTB);
end

%[~, cind] = sort(sum(x), 'descend'); %rank order biomass    

%% plot fraction biovolume of select species
figure('Units','inches','Position',[1 1 8 6],'PaperPositionMode','auto');
subplot = @(m,n,p) subtightplot (m, n, p, [0.03 0.03], [0.08 0.04], [0.11 0.2]);
%subplot = @(m,n,p) subtightplot(m,n,p,opt{:}); 
%where opt = {gap, width_h, width_w} describes the inner and outer spacings.  

%Fraction dinos and diatoms
subplot(3,1,1);
fx_other=(ymat-(ydino+ydiat))./ymat; %fraction not dinos or diatoms

bar(xmat, [ydino./ymat ydiat./ymat fx_other], 0.5, 'stack');
ax = get(gca);
cat = ax.Children;

cstr = [ [220 220 220]/255; [110 110 110]/255; [0 0 0]/255]; %black/dk grey/lt grey
for ii = 1:length(cat)
    set(cat(ii), 'FaceColor', cstr(ii,:),'BarWidth',1)
end

datetick('x', 3, 'keeplimits')
xlim(datenum([['01-Jan-' num2str(year) '']; ['01-Jul-' num2str(year) '']]))
ylim([0;1])
set(gca,'xticklabel',{}, 'fontsize', 10, 'fontname', 'arial','tickdir','out')
ylabel({'Fraction';'of biovolume'}, 'fontsize', 11, 'fontname', 'arial','fontweight','bold')
h=legend('dinoflagellates','diatoms','other cell-derived');
set(h,'Position',[0.810763891876882 0.890190973968452 0.166666663678673 0.0651041649204368]);
hold on

%species breakdown
subplot(3,1,2);
 
select_dino=[BIO(strmatch('Akashiwo',class2useTB)).bio,...
    BIO(strmatch('Ceratium',class2useTB)).bio,...
    BIO(strmatch('Dinophysis',class2useTB)).bio,...
    BIO(strmatch('Lingulodinium',class2useTB)).bio,...
    BIO(strmatch('Prorocentrum',class2useTB)).bio];
fx_otherdino=(ydino-sum(select_dino,2))./ymat; %fraction other dinos

select_diat=[BIO(strmatch('Chaetoceros',class2useTB)).bio,...
    BIO(strmatch('Det_Cer_Lau',class2useTB)).bio,...
    BIO(strmatch('Eucampia',class2useTB)).bio,...
    BIO(strmatch('Guin_Dact',class2useTB)).bio,...    
    BIO(strmatch('Pseudo-nitzschia',class2useTB)).bio,...
    BIO(strmatch('Centric',class2useTB)).bio,...    
    BIO(strmatch('Pennate',class2useTB)).bio];
fx_otherdiat=(ydiat-sum(select_diat,2))./ymat; %fraction other dinos

bar(xmat,[select_dino./ymat select_diat./ymat fx_otherdino fx_otherdiat fx_other], 0.5, 'stack');

ax=get(gca); cat = ax.Children;
col_diat1=flipud(brewermap(6,'BuGn'));
col_diat2=flipud(brewermap(6,'BuPu'));
col_dino=(brewermap(6,'YlOrRd'));

cstr=[[220 220 220]/255; [110 110 110]/255; [0 0 0]/255;...
    col_diat2(1:4,:); col_diat1(1:3,:); col_dino(1:5,:)];

for ii = 1:length(cat)
    set(cat(ii), 'FaceColor', cstr(ii,:),'BarWidth',1)
end

datetick('x', 3, 'keeplimits')
xlim(datenum([['01-Jan-' num2str(year) '']; ['01-Jul-' num2str(year) '']]))
ylim([0;1])
set(gca,'xticklabel',{}, 'fontsize', 10, 'fontname', 'arial','tickdir','out')
ylabel({'Fraction';'of biovolume'}, 'fontsize', 11, 'fontname', 'arial','fontweight','bold')
h=legend('Akashiwo','Ceratium','Dinophysis','Lingulodinium','Prorocentrum',...
    'Chaetoceros','DetCerLau','Eucampia','GuinDact','Pseudo-nitzschia',...
    'Centric diatoms','Pennate diatoms','other dinos','other diatoms','other cell-derived');
set(h,'Position',[0.808159725831097 0.399956604207141 0.187499996391125 0.246744784681747]);
hold on

%total cell-derived biovolume
subplot(3,1,3);
plot(xmat, smooth(ymat./ymat_ml,2),'k.-','linewidth', 1);
hold on
datetick('x', 3, 'keeplimits')
xlim(datenum([['01-Jan-' num2str(year) '']; ['01-Jul-' num2str(year) '']]))
set(gca,'yscale','log','ylim',[10^3 2*10^5],'xgrid','on',...
    'fontsize', 10, 'fontname', 'arial','tickdir','out')
ylabel({'Biovolume';'(\mum^{-3} mL^{-1})'}, 'fontsize', 11, 'fontname', 'arial','fontweight','bold')
hold all

% set figure parameters
set(gcf,'color','w');
print(gcf,'-dtiff','-r600',[figpath 'Figs\FxBiovolume_IFCB_SCW_' num2str(year) '.tif']);
hold off


%% plot pcolor temperature profile, delta T MLD, and  dinos/diatom

figure('Units','inches','Position',[1 1 8 8],'PaperPositionMode','auto');
subplot = @(m,n,p) subtightplot (m, n, p, [0.02 0.02], [0.06 0.04], [0.1 0.12]);
%subplot = @(m,n,p) subtightplot(m,n,p,opt{:}); 
%where opt = {gap, width_h, width_w} describes the inner and outer spacings.

xax1=datenum(['' num2str(year) '-01-01']); xax2=datenum(['' num2str(year) '-07-01']);  

subplot(7,1,1); %ROMS Salinity
    X=[ROMS.dn]';
    Y=[ROMS(1).Zi]';
    C=[ROMS.Si];
    colormap(jet);    
    pcolor(X,Y,C); shading interp;
    caxis([33.2 33.9]); datetick('x','mmm');  grid on; 
    hold on
    set(gca,'XLim',[xax1;xax2],'xaxislocation','top',...
        'Ydir','reverse','ylim',[0 40],'ytick',0:20:40,'fontsize',9,'tickdir','out');
    ylabel('Depth (m)','fontsize',10,'fontweight','bold');
    h=colorbar('Position',[0.897569444444444 0.850260416666667 0.0190972222222224 0.110677083333333]);
    h.Label.String = 'S (g kg^{-1})';
    h.FontSize = 8;
    h.Label.FontSize = 10;
    h.Label.FontWeight = 'bold';
    h.TickDirection = 'out';
    hold on
    
subplot(7,1,2); %SCW ROMS Temp
    X=[ROMS.dn]';
    Y=[ROMS(1).Zi]';
    C=[ROMS.Ti];
    colormap(jet);
    pcolor(X,Y,C); shading interp;
    caxis([10 16]); datetick('x',4);  grid on; 
    hold on
    xlim([xax1;xax2])        
    set(gca,'xticklabel',{},'Ydir','reverse','ylim',[0 40],'ytick',0:20:40,'fontsize',9,'tickdir','out');
    ylabel('Depth (m)','fontsize',10,'fontweight','bold');
    h=colorbar('Position',[0.897569444444444 0.721354166666667 0.017795138888889 0.110677083333333]); 
    h.FontSize = 8;
    h.Label.String = 'T (^oC)';     
    h.Label.FontSize = 10;
    h.Label.FontWeight = 'bold';
    h.TickDirection = 'out';
    hold on
  
subplot(7,1,3); %ROMS MLD
    X=[ROMS.dn]';
    Y=[ROMS(1).Zi]';
    C=[ROMS.diff];
    pcolor(X,Y,C); shading interp;
    caxis([0 0.5]); datetick('x','m');  grid on; 
    hold on
    hh=plot(X,smooth([ROMS.mld5],20),'k-','linewidth',3);
    hold on
    xlim(datenum([['01-Jan-' num2str(year) '']; ['01-Jul-' num2str(year) '']]))   
set(gca,'XLim',[xax1;xax2],'xticklabel',{},...
'Ydir','reverse','ylim',[0 40],'ytick',0:20:40,'fontsize',9,'tickdir','out');
    datetick('x','m','keeplimits','keepticks');
    ylabel('Depth (m)','fontsize',10,'fontweight','bold');
    h=colorbar('Position',[0.898871527777778 0.588541666666666 0.0190972222222223 0.110677083333333]); 
    h.Label.String = '\DeltaT from 0m (^oC)';
    h.FontSize = 8;
    h.Label.FontSize = 10;
    h.Label.FontWeight = 'bold';
    h.TickDirection = 'out';
    hold on
    legend([hh(1)],'\DeltaT = 0.5^oC','Location','SE');
    


    X=[ROMS.dn]';
    Y=[ROMS(1).Zi(1:40)]';
    C=[ROMS.dTdz];
    colormap(jet);    
    pcolor(X,Y,C); shading interp;
    caxis([0 0.2]); datetick('x',4);  grid on; 
    hold on
    plot(X,smooth([ROMS.Zmax],20),'w-','linewidth',2);
    hold on
    set(gca,'XLim',[xax1;xax2],'xticklabel',{},...
        'Ydir','reverse','ylim',[0 40],'ytick',0:20:40,'fontsize',9,'tickdir','out');
    ylabel('Depth (m)','fontsize',10,'fontweight','bold');
    h=colorbar('Position',[0.898871527777778 0.588541666666666 0.0190972222222223 0.110677083333333]); 
    h.Label.String = 'dTdz (^oC m^{-1})';
    h.FontSize = 8;
    h.Label.FontSize = 10;
    h.Label.FontWeight = 'bold';
    h.TickDirection = 'out';
    hold on
    
subplot(7,1,4); %SCW wind
    [U,~]=plfilt(W.SC(6).U,W.SC(6).DN);
    [V,DN]=plfilt(W.SC(6).V,W.SC(6).DN);
    [~,u,~] = ts_aggregation(DN,U,1,'8hour',@mean);
    [time,v,~] = ts_aggregation(DN,V,1,'8hour',@mean);
    yax1=-5; yax2=5;
    stick(time,u,v,xax1,xax2,yax1,yax2,'');
    xlim([xax1;xax2])    
    datetick('x','mmm','keeplimits','keepticks');   
    set(gca,'xticklabel',{});    
    ylabel('Wind (m s^{-1})','fontsize',10,'fontname','arial','fontweight','bold');  
    hold on    
       
subplot(7,1,5);
    plot(SC.dn,SC.river,'-k','linewidth',1.5);
    xlim([xax1;xax2]);    
    datetick('x', 3, 'keeplimits')    
    set(gca,'yscale','log','ylim',[10 10^4],'xgrid','on','xticklabel',{},...
        'fontsize',9,'tickdir','out'); 
    ylabel({'Discharge';'(ft^3 s^{-1})'},'fontsize',10,'fontweight','bold');
hold on    
    
subplot(7,1,6); %Fraction dinos and diatoms
%     bar(r(60).dn, [r(60).rai r(61).rai], 3, 'stack');
    bar(xmat, [ydino./[ydino+ydiat] ydiat./[ydino+ydiat]], 0.5, 'stack');
    ax = get(gca);
    cat = ax.Children;
    cstr = [ [200 200 200]/255; [80 80 80]/255]; %black/dk grey/lt grey
    for ii = 1:length(cat)
        set(cat(ii), 'FaceColor', cstr(ii,:),'BarWidth',1)
    end
hold on
    datetick('x', 3, 'keeplimits')
    xlim([xax1;xax2])    
    ylim([0;1])
    set(gca,'xgrid','on', 'fontsize', 9, 'fontname', 'arial','tickdir','out','Xticklabel',{})
    ylabel({'Fraction of';'Biovolume'}, 'fontsize', 10, 'fontname', 'arial','fontweight','bold')
    h=legend('dinos','diatoms','Location','NE');
    h.FontSize = 8;    
    hold on    

subplot(7,1,7);  
yyaxis left %total cell-derived biovolume
    h1=plot(xmat, smooth(ymat./ymat_ml,1),'k-','linewidth', 1);
    datetick('x', 3, 'keeplimits')
    xlim([xax1;xax2]);    
    set(gca,'yscale','log','ylim',[10^3 10^6],'xgrid','on','fontsize', 9, 'fontname', 'arial',...
        'xaxislocation','top','tickdir','out','ycolor','k','Xticklabel',{})
    ylabel({'Biovolume';'(\mum^{-3} mL^{-1})'},'fontsize',10,'fontname','arial','fontweight','bold')
    hold on      
    
yyaxis right %Chlorophyll
    h2=plot(SC.dn,SC.CHL,'*-','Markersize',4,'Color',[0.8500 0.3250 0.0980]);
    hold on
    h3=plot(SC.dn,SC.CHLsensor,'-','linewidth',1,'Color',[0.8500 0.3250 0.0980]);
    xlim([xax1;xax2]);    
    set(gca,'yscale','log','ylim',[1 40],'xgrid','on','fontsize',9, 'fontname', 'arial',...
        'xaxislocation','bottom','tickdir','out','ycolor','k','ycolor',[0.8500 0.3250 0.0980])   
    datetick('x','mmm','keeplimits','keepticks');        
    ylabel('Chl (mg m^{-3})','Color',[0.8500 0.3250 0.0980],'fontsize',10,'fontname','arial','fontweight','bold');         
    hold on    
    
% set figure parameters
set(gcf,'color','w');
print(gcf,'-dtiff','-r600',[figpath 'Figs\Dino-Diatom_W_D_S_T_' num2str(year) '.tif']);
hold off

%% Just temperature
figure('Units','inches','Position',[1 1 8 2],'PaperPositionMode','auto');

for i=1:length(ROMS)
    T_surf(i)=ROMS(i).T(1);
end

xax1=datenum('2018-01-01'); xax2=datenum('2018-07-01');  
    plot([ROMS.dn],smooth(T_surf,10),'-','color',[.5 .5 0],'linewidth',1.5);
    hold on
    plot(S.dn(2293:2418),smooth(S.temp(2293:2418),5),'-','Color',[0 0.4470 0.7410],'linewidth',1.5);
    hold on
    plot(a.dn,(a.temp),'o','Markersize',4,'Color',[0 0.4470 0.7410]);
    hold on    
    %plot(M1(3).dn,(M1(3).T),'-','color',[.5 .5 0]);
    datetick('x','m');
    axis([xax1 xax2 10 16]); 
    datetick('x', 3, 'keeplimits')    
    set(gca,'xgrid', 'on','xlim',[xax1 xax2],'ylim',[10 16],'ytick',10:2:16,'fontsize',10,...
    'xaxislocation','bottom','tickdir','out');   
    ylabel('SST (^oC)','fontsize',10,'fontname','arial','fontweight','bold');
    legend('ROMS','SCW sensor','SCW weekly','Location','EastOutside');
    hold on

% set figure parameters
set(gcf,'color','w');
print(gcf,'-dtiff','-r600',[figpath 'Figs\TEMP_comparison.tif']);
hold off

%% plot dinos vs diatoms
figure, %set(gcf, 'position', [360 278 500 250])
cstr = ['rbkgcmy']; %order of colors

ph = plot(xdino, ydino./ydino_ml,'.-', xdiat, ydiat./ydiat_ml,'.-','linewidth', 1);
for ii = 1:length(ph)
    set(ph(ii), 'color', cstr(ii))
end
datetick('x', 3, 'keeplimits')
xlim(datenum([['01-Jan-' num2str(year) '']; ['01-Jul-' num2str(year) '']]))
ylabel('Biovolume ( \mum^{ -3} mL^{ -1})', 'fontsize', 16, 'fontname', 'arial')
legend('dinoflagellates','diatoms','Location','NorthEast')
set(gca, 'fontsize', 16, 'fontname', 'arial','tickdir','out')
set(gcf, 'position', [360 278 750 375])

%% plot dino and diatoms in proportion to total biovolume
figure('Units','inches','Position',[1 1 8 5],'PaperPositionMode','auto');
subplot = @(m,n,p) subtightplot (m, n, p, [0.05 0.05], [0.08 0.04], [0.09 0.2]);
%subplot = @(m,n,p) subtightplot(m,n,p,opt{:}); 
%where opt = {gap, width_h, width_w} describes the inner and outer spacings.
 
fx_other=[ymat-[ydino+ydiat]]./ymat; %fraction not dinos or diatoms

%Fraction dinos and diatoms
subplot(2,1,1);
bar(xmat, [ydino./ymat ydiat./ymat fx_other], 0.5, 'stack');
ax = get(gca);
cat = ax.Children;

cstr = [ [166,206,227]/255; [31,120,180]/255; [178,223,138]/255;...
    [51,160,44]/255; [251,154,153]/255; [227,26,28]/255;...
    [253,191,111]/255; [255,127,0]/255; [202,178,214]/255; [106,61,154]/255 ];

for ii = 1:length(cat)
    set(cat(ii), 'FaceColor', cstr(ii,:),'BarWidth',1)
end

datetick('x', 3, 'keeplimits')
xlim(datenum([['01-Jan-' num2str(year) '']; ['01-Jul-' num2str(year) '']]))
ylim([0;1])
set(gca,'xticklabel',{}, 'fontsize', 10, 'fontname', 'arial','tickdir','out')
ylabel('Fraction of total biovolume', 'fontsize', 12, 'fontname', 'arial','fontweight','bold')
h=legend('dinoflagellates','diatoms','other');
set(h,'Position',[0.810763891876882 0.718055558349523 0.166666663678673 0.104166663872699]);
hold on

%total cell-derived biovolume
subplot(2,1,2);
plot(xmat, ymat./ymat_ml,'k.-','linewidth', 1);
hold on
datetick('x', 3, 'keeplimits')
xlim(datenum([['01-Jan-' num2str(year) '']; ['01-Jul-' num2str(year) '']]))
ylim([0;3.2*10^5])
set(gca,'xgrid','on','fontsize', 10, 'fontname', 'arial','tickdir','out')
ylabel('Biovolume (\mum^{-3} mL^{-1})', 'fontsize', 12, 'fontname', 'arial','fontweight','bold')
hold all

% set figure parameters
set(gcf,'color','w');
print(gcf,'-dtiff','-r600',[figpath 'Figs\Diatom_Dino_IFCB_' num2str(year) '.tif']);
hold off
