filepath = '~/Documents/MATLAB/bloom-baby-bloom/ACIDD2017/'; 

%%%% Step 1: Load in data
[class2useTB,classcountTB,classbiovolTB,ml_analyzedTB,mdateTB,filelistTB]=...
    excludebiovolACIDD(...
    '~/Documents/MATLAB/bloom-baby-bloom/ACIDD2017/Data/IFCB_summary/class/',...
    'summary_biovol_allTB2017',[1:3,51:56,69:78,85:90,97:98,111:122,147:156]);

%%%% Step 2: Convert Biovolume to Carbon
% convert Biovolume (cubic microns/cell) to Carbon (picograms/cell)
[ ind_diatom, ~ ] = get_diatom_ind_CA( class2useTB, class2useTB );
[ cellC ] = biovol2carbon(classbiovolTB, ind_diatom ); 

%convert from per cell to per mL
volC=zeros(size([cellC]));
volB=zeros(size([cellC]));

for i=1:length(cellC)
    volC(i,:)=cellC(i,:)./ml_analyzedTB(i);
    volB(i,:)=classbiovolTB(i,:)./ml_analyzedTB(i);    
end
    
%convert from pg/mL to ug/L 
volC=volC./1000;

%%%% Step 3: Determine what fraction of Cell-derived carbon is 
% Dinoflagellates vs Diatoms vs Classes of interest

%select total living biovolume 
[ ind_cell, ~ ] = get_cell_ind_CA( class2useTB, class2useTB );
cell=nansum(volC(:,ind_cell),2);

%select only diatoms
[ ind_diatom, ~ ] = get_diatom_ind_CA( class2useTB, class2useTB );
diatom=nansum(volC(:,ind_diatom),2);

%select only dinoflagellates
[ ind_dino, ~ ] = get_dino_ind_CA( class2useTB, class2useTB );
dino=nansum(volC(:,ind_dino),2);

%select only nanoplankton
[ ind_nano, ~ ] = get_nano_ind_CA( class2useTB, class2useTB );
nano=nansum(volC(:,ind_nano),2);

%%%% Step 4: import your cell count data
%General input
in_dir = '~/Documents/MATLAB/bloom-baby-bloom/';
class_sum = 'ACIDD2017/Data/IFCB_summary/class/summary_allTB_bythre_'; 
Thr_sum = 'SCW/Data/IFCB_summary/Coeff_';
biovol_sum = 'ACIDD2017/Data/IFCB_summary/manual/count_biovol_manual_23Aug2018';
remove = [1:3,51:56,69:78,85:90,97:98,111:122,147:156];


class2do_string = 'Chaetoceros';
[CHA]=excludecellcountACIDD(in_dir,class_sum,class2do_string,Thr_sum,biovol_sum,remove);

class2do_string = 'Dinophysis';
[DINO]=excludecellcountACIDD(in_dir,class_sum,class2do_string,Thr_sum,biovol_sum,remove);

class2do_string = 'Lingulodinium';
[LING]=excludecellcountACIDD(in_dir,class_sum,class2do_string,Thr_sum,biovol_sum,remove);

class2do_string = 'Prorocentrum';
[PRO]=excludecellcountACIDD(in_dir,class_sum,class2do_string,Thr_sum,biovol_sum,remove);

class2do_string = 'Centric';
[CEN]=excludecellcountACIDD(in_dir,class_sum,class2do_string,Thr_sum,biovol_sum,remove);

class2do_string = 'Pennate';
[PEN]=excludecellcountACIDD(in_dir,class_sum,class2do_string,Thr_sum,biovol_sum,remove);

clearvars Thr_sum biovol_sum class_sum ind_cell ind_diatom ind_dino ind_nano ...
    class2do_string in_dir class2useTB classbiovolTB classcountTB filelistTB i remove

% Thalassiosira
%Thalassionema

% %%%% Step 4: Bin Equivalent Sphaerical Diameter
% diambins=0:5:30; %decide what kind of size bins you want to look at
% clear bincount
% bincount=NaN(length(eqdiam),length(diambins));
% 
% %bincount is a matrix of counts/ml for each diameter bin (as specified in
% %diambin) by each file....or essentially histogram values
% for i=1:length(eqdiam)
%     [d,bins]=hist(eqdiam{i,1},diambins); %This looks at equivalent spherical diameter, 
%     bincount(i,:)=d./ml_analyzed(i);
% end
% 
% %creates your daybins for each diambin
% for i=1:length(diambins)
%     [matdate_bin, classcount_bin, ml_analyzed_mat_bin] = make_day_bins(matdate,bincount(:,i),ml_analyzed);
%     daybin_perml(:,i)=classcount_bin./ml_analyzed_mat_bin; 
% end


%% plot fraction biovolume of select species
figure('Units','inches','Position',[1 1 8 8],'PaperPositionMode','auto');
subplot = @(m,n,p) subtightplot (m, n, p, [0.03 0.03], [0.08 0.04], [0.11 0.3]);
%subplot = @(m,n,p) subtightplot(m,n,p,opt{:}); 
%where opt = {gap, width_h, width_w} describes the inner and outer spacings.  

xax1=datenum(2017,12,17,15,0,0); xax2=datenum(2017,12,22,10,0,0);     

%total cell-derived biovolume
subplot(3,1,1);
plot(mdateTB,cell./ml_analyzedTB,'k-','linewidth',1);
    hold on
    xlim([xax1 xax2]);
    set(gca,'yscale','log','xgrid','on','ylim',[0 10^3],'xaxislocation','top',...
        'fontsize', 14, 'fontname', 'arial','tickdir','out');
    datetick('x','mmmdd', 'keeplimits')
    ylabel('Carbon (\mug L^{-1})', 'fontsize', 16, 'fontname', 'arial','fontweight','bold')
    hold on

subplot(3,1,2); 
h=plot(PRO.mdateTB,PRO.y_mat_manual,'-o',...
    LING.mdateTB,LING.y_mat_manual,'-o',CHA.mdateTB,CHA.y_mat_manual,'-o',...
    CEN.mdateTB,CEN.y_mat_manual,'-o',PEN.mdateTB,PEN.y_mat_manual,'-o',...
    'linewidth',1.5,'markersize',2);
    
col_dino1=flipud(brewermap(10,'PiYG'));
col_dino2=(brewermap(4,'YlOrBr'));
col_diat1=flipud(brewermap(7,'YlGnBu'));
col_diat2=(brewermap(5,'Purples'));

set(h(1),'Color',col_dino1(10,:)); 
set(h(2),'Color',col_dino2(4,:)); 
set(h(3),'Color',col_diat1(6,:)); 
set(h(4),'Color',col_diat2(5,:)); %Cen
set(h(5),'Color',col_diat2(4,:)); %Pen

    hold on
    xlim([xax1 xax2]);
    datetick('x','mmmdd', 'keeplimits')
    set(gca,'xgrid','on','xticklabel',{},...
        'fontsize', 14, 'fontname', 'arial','tickdir','out');
    ylabel('Cells mL^{-1}', 'fontsize', 16, 'fontname', 'arial','fontweight','bold')
    lh=legend('Prorocentrum','Linguodinum','Chaeotoceros','Centric diatoms','Pennate diatoms');
    set(lh,'FontSize',14,'box','off',...
        'Position',[0.72048611111111 0.711371527777777 0.164930555555556 0.221354166666667]);    
    hold on

%Fraction dinos and diatoms and nanoplankton
subplot(3,1,3);
fx_other=(cell-(dino+diatom+nano))./cell; %fraction not dinos or diatoms or nanoplankton
    
col=flipud(brewermap(4,'Spectral'));

bar(mdateTB, [diatom./cell dino./cell nano./cell fx_other], 1, 'stack','Edgecolor','none');
xlim([xax1 xax2]);

ax = get(gca);
cat = ax.Children;

ax=get(gca); cat = ax.Children;

for ii = 1:length(cat)
    set(cat(ii), 'FaceColor', col(ii,:),'BarWidth',1)
end
hold on
set(gca,'ylim',[0 1],'fontsize', 14, 'fontname', 'arial','tickdir','out');
%set(gca,'yscale','log','ylim',[10^1 10^3],'xlim',[xax1 xax2],'fontsize', 14, 'fontname', 'arial','tickdir','out');
ylabel({'Fraction of biomass'}, 'fontsize', 16, 'fontname', 'arial','fontweight','bold')
h=legend('dinoflagellates','diatoms','nanoplankton','other cell-derived');
set(h,'FontSize',14,'box','off',...
    'Position',[0.712673612605106 0.162905093465707 0.276041666666666 0.142361111111111]);
hold on
datetick('x','mmmdd', 'keeplimits')

% set figure parameters
set(gcf,'color','w');
print(gcf,'-dtiff','-r600',[filepath 'Figs/FxBiovolume_ACIDD.tif']);
hold off

